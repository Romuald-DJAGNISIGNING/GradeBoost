from allauth.account.internal import flows
from allauth.usercustom_sessions.adapter import get_adapter
from allauth.usercustom_sessions.models import UserSession


def end_other_custom_sessions(request, user):
    custom_sessions_to_end = []
    for session in UserSession.objects.filter(user=user):
        if session.is_current():
            continue
        custom_sessions_to_end.append(session)
    end_custom_sessions(request, custom_sessions_to_end)


def end_custom_sessions(request, custom_sessions):
    has_current = any([session.is_current() for session in custom_sessions])
    get_adapter().end_custom_sessions(custom_sessions)
    if has_current:
        flows.logout.logout(request)
