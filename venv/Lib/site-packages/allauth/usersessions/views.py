from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.urls import reverse_lazy
from django.utils.decorators import method_decorator
from django.views.generic.edit import FormView

from allauth.account import app_settings as account_settings
from allauth.account.adapter import get_adapter as get_account_adapter
from allauth.usercustom_sessions import app_settings
from allauth.usercustom_sessions.forms import ManageUsercustom_sessionsForm
from allauth.usercustom_sessions.models import UserSession


@method_decorator(login_required, name="dispatch")
class ListUsercustom_sessionsView(FormView):
    template_name = (
        "usercustom_sessions/usersession_list." + account_settings.TEMPLATE_EXTENSION
    )
    form_class = ManageUsercustom_sessionsForm
    success_url = reverse_lazy("usercustom_sessions_list")

    def get_context_data(self, **kwargs):
        ret = super().get_context_data(**kwargs)
        custom_sessions = sorted(
            UserSession.objects.purge_and_list(self.request.user),
            key=lambda s: s.created_at,
        )
        ret["custom_sessions"] = custom_sessions
        ret["session_count"] = len(custom_sessions)
        ret["show_last_seen_at"] = app_settings.TRACK_ACTIVITY
        return ret

    def get_form_kwargs(self):
        ret = super().get_form_kwargs()
        ret["request"] = self.request
        return ret

    def form_valid(self, form):
        form.save(self.request)
        get_account_adapter().add_message(
            self.request,
            messages.INFO,
            "usercustom_sessions/messages/custom_sessions_logged_out.txt",
        )
        return super().form_valid(form)


list_usercustom_sessions = ListUsercustom_sessionsView.as_view()
